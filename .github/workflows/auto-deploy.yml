name: Auto Deploy to Cloud Run

on:
  repository_dispatch:
    types: [deploy-request]
  push:
    branches:
      - master
      - main
  workflow_dispatch:

jobs:
  detect-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Read deploy config
        id: config
        run: |
          echo "Reading deploy-config.json..."
          cat deploy-config.json
      
      - name: Detect changed projects
        id: changes
        run: |
          # Get list of changed files
          git diff --name-only HEAD~1 HEAD > changed_files.txt || echo "deploy-config.json" > changed_files.txt
          
          echo "Changed files:"
          cat changed_files.txt
          
          # Check if deploy-config.json was modified (new project added)
          if grep -q "deploy-config.json" changed_files.txt; then
            echo "CONFIG_CHANGED=true" >> $GITHUB_OUTPUT
            echo "Deploy config was modified - will deploy all active projects"
          fi
      
      - name: Parse projects from config
        id: projects
        run: |
          # Extract active projects from deploy-config.json
          PROJECTS=$(node -e "
            const config = require('./deploy-config.json');
            const active = config.projects.filter(p => p.active);
            console.log(JSON.stringify(active.map(p => ({
              name: p.name,
              repo: p.repository,
              service: p.serviceName,
              port: p.port || 8080,
              dockerfile: p.dockerfile || 'Dockerfile'
            }))));
          ")
          echo "PROJECTS=$PROJECTS" >> $GITHUB_OUTPUT
          echo "Active projects: $PROJECTS"
      
      - name: Filter project to deploy
        id: filter
        run: |
          # If triggered by repository_dispatch, only deploy that specific project
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            PROJECT_NAME="${{ github.event.client_payload.project_name }}"
            echo "Deploying specific project: $PROJECT_NAME"
            
            PROJECTS='${{ steps.projects.outputs.PROJECTS }}'
            FILTERED=$(echo "$PROJECTS" | node -e "
              const all = JSON.parse(require('fs').readFileSync(0, 'utf-8'));
              const name = process.argv[1];
              const filtered = all.filter(p => p.name === name);
              console.log(JSON.stringify(filtered));
            " "$PROJECT_NAME")
            
            echo "DEPLOY_PROJECTS=$FILTERED" >> $GITHUB_OUTPUT
          else
            # Deploy all active projects
            echo "Deploying all active projects"
            echo "DEPLOY_PROJECTS=${{ steps.projects.outputs.PROJECTS }}" >> $GITHUB_OUTPUT
          fi
      
      # Authenticate with Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev
      
      - name: Create Artifact Registry repository if needed
        run: |
          PROJECT_ID=$(node -e "console.log(require('./deploy-config.json').googleCloud.projectId)")
          REGION=$(node -e "console.log(require('./deploy-config.json').googleCloud.region)")
          
          # Check if repository exists
          if ! gcloud artifacts repositories describe cloud-run-source-deploy \
            --location=$REGION \
            --project=$PROJECT_ID \
            --format="value(name)" 2>/dev/null; then
            
            echo "Creating Artifact Registry repository: cloud-run-source-deploy"
            gcloud artifacts repositories create cloud-run-source-deploy \
              --repository-format=docker \
              --location=$REGION \
              --project=$PROJECT_ID \
              --description="Docker images for Cloud Run deployments"
            
            echo "âœ… Repository created successfully!"
          else
            echo "âœ… Repository already exists"
          fi
      
      # Deploy each active project
      - name: Deploy projects
        run: |
          PROJECTS='${{ steps.filter.outputs.DEPLOY_PROJECTS }}'
          echo "$PROJECTS" | node -e "
            const projects = JSON.parse(require('fs').readFileSync(0, 'utf-8'));
            const config = require('./deploy-config.json');
            
            projects.forEach(project => {
              console.log(\`\n========================================\`);
              console.log(\`Deploying: \${project.name}\`);
              console.log(\`========================================\n\`);
              
              // Clone the repository
              const repoName = project.name;
              const repoUrl = project.repo;
              
              console.log(\`Cloning \${repoUrl}...\`);
              require('child_process').execSync(\`git clone \${repoUrl} /tmp/\${repoName}\`, { stdio: 'inherit' });
              
              // Build and push Docker image
              const projectId = config.googleCloud.projectId;
              const region = config.googleCloud.region;
              const imageName = \`\${region}-docker.pkg.dev/\${projectId}/cloud-run-source-deploy/\${project.service}\`;
              
              console.log(\`Building Docker image...\`);
              require('child_process').execSync(
                \`docker build -t \${imageName} -f /tmp/\${repoName}/\${project.dockerfile} /tmp/\${repoName}\`,
                { stdio: 'inherit' }
              );
              
              console.log(\`Pushing Docker image...\`);
              require('child_process').execSync(\`docker push \${imageName}\`, { stdio: 'inherit' });
              
              // Deploy to Cloud Run
              const deployCmd = \`
                gcloud run deploy \${project.service} \\
                  --image \${imageName} \\
                  --platform managed \\
                  --region \${region} \\
                  --project \${projectId} \\
                  --port \${project.port} \\
                  --memory \${config.googleCloud.defaultConfig.memory} \\
                  --cpu \${config.googleCloud.defaultConfig.cpu} \\
                  --min-instances \${config.googleCloud.defaultConfig.minInstances} \\
                  --max-instances \${config.googleCloud.defaultConfig.maxInstances} \\
                  --timeout \${config.googleCloud.defaultConfig.timeout} \\
                  --allow-unauthenticated \\
                  --quiet
              \`;
              
              console.log(\`Deploying to Cloud Run...\`);
              require('child_process').execSync(deployCmd, { stdio: 'inherit' });
              
              console.log(\`âœ… \${project.name} deployed successfully!\n\`);
            });
          "
      
      - name: Deployment complete
        run: |
          echo "ðŸŽ‰ All projects deployed successfully!"
          echo "Check status at: https://console.cloud.google.com/run"
